{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-kanban"></i> Fluxo de Produção</h2>
        <button class="btn btn-primary shadow" data-bs-toggle="modal" data-bs-target="#modalVenda">
            <i class="bi bi-cart-plus-fill"></i> Nova Venda / Orçamento
        </button>
    </div>

    <div class="row flex-nowrap overflow-auto pb-3">
        {% for setor in setores %}
        <div class="col-md-4" style="min-width: 350px;">
            <div class="card bg-light border-0 shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between">
                    <span>{{ setor.nome }}</span>
                    <span class="badge bg-secondary">{{ setor.cards|length }}</span>
                </div>
                <div class="card-body p-2" style="min-height: 70vh;">
                    {% for card in setor.cards %}
                    <div class="card mb-2 shadow-sm border-start border-4" style="border-color: {{ card.status_ref.cor if card.status_ref else '#ccc' }} !important;">
                        <div class="card-body p-3">
                            <h6 class="card-title fw-bold mb-1">{{ card.titulo }}</h6>
                            <p class="small text-muted mb-2">
                                <i class="bi bi-person"></i> {{ card.cliente_ref.nome if card.cliente_ref else 'Sem cliente' }}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-light text-dark border">
                                    <i class="bi bi-calendar-event"></i> {{ card.prazo }}
                                </span>
                                <span class="fw-bold text-primary">R$ {{ "%.2f"|format(card.valor_total) }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="modalVenda" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form action="{{ url_for('criar_venda') }}" method="POST" class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-cash-stack"></i> Novo Pedido & Financeiro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-7 border-end">
                        <div class="mb-3">
                            <label class="form-label">Cliente</label>
                            <select name="cliente_id" class="form-select" required>
                                <option value="" selected disabled>Selecione...</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">O que será produzido?</label>
                            <input type="text" name="servico" class="form-control" required placeholder="Ex: Banner 1x1m">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Detalhes</label>
                            <textarea name="detalhes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="mb-3">
                            <label class="form-label text-success fw-bold">Valor Total (R$)</label>
                            <input type="number" step="0.01" name="valor" class="form-control form-control-lg border-success" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Prazo de Entrega</label>
                            <input type="date" name="prazo" class="form-control" required>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary w-100">Gerar Pedido e Financeiro</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}